- name: 执行构建并手动签名 (彻底修复版)
        run: |
          # 1. 尝试初始构建，生成必要文件
          flutter build macos --release || true
          
          # 2. 定位 App 路径
          APP_PATH="build/macos/Build/Products/Release/echotrace.app"
          
          if [ -d "$APP_PATH" ]; then
            echo "正在修复权限并清除现有签名..."
            # 清除所有可能导致冲突的旧签名
            find "$APP_PATH" -name "_CodeSignature" -exec rm -rf {} +
            
            echo "正在对内部 Frameworks 进行逐个签名..."
            # 先给嵌套的最深层组件签名，解决 bundle format is ambiguous 错误
            find "$APP_PATH/Contents/Frameworks" -type d -name "*.framework" -exec codesign --force --sign - --timestamp=none {} \;
            
            echo "正在对可执行文件进行签名..."
            # 给内部的动态库签名
            find "$APP_PATH/Contents/Frameworks" -type f -name "*.dylib" -exec codesign --force --sign - --timestamp=none {} \;
            
            echo "正在对主程序包进行整体签名..."
            # 最后对整个 Bundle 签名
            codesign --force --sign - --timestamp=none "$APP_PATH"
          else
            echo "错误：未找到构建产物，请检查前面的编译日志。"
            exit 1
          fi
          
          # 3. 最终确认构建
          flutter build macos --release
        env:
          CODE_SIGNING_ALLOWED: NO
          CODE_SIGNING_REQUIRED: NO
